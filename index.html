<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VAST 2019 MC2</title>
    <script src="d3.v7.min.js"></script>
</head>
<body>
    <script src="client_js/geoScatter.js"></script>
    <script src="client_js/sensorHist.js"></script>
    <script>
        // Authored by Julia Santos Nothaft and Patrick Feeney
        async function loadCSV(path, row_conv)
        {
            const response = await fetch(path);
            return d3.csvParse(await response.text(), row_conv);
        }

        async function loadData(start_date="2020-04-06T04:00:10", end_date="2020-04-06T08:00:10",
                                min_val=0, max_val=10000, id=null)
        {
            data_str = "data?start_date=" + start_date + "&"
                + "end_date=" + end_date + "&"
                + "min_val=" + min_val.toString() + "&"
                + "max_val=" + max_val.toString();
            if (id != null)
                data_str += "&tag=" + id;
            const response = await fetch(data_str);
            return response.json();
        }

        function updateSensorSelect(data)
        {
            tagsSet = new Set();
            for (i in data)
            {
                tagsSet.add(data[i].id);
            }
            tagsArray = Array.from(tagsSet).sort();
            tagsArray.splice(0, 0, "All");
            sensorSelect = d3.select("#sensorSelect");
            for (i in tagsArray)
            {
                sensorSelect.append("option").text(tagsArray[i]);
            }
        }

        function onSensorSelect()
        {
            selectedTag = d3.select("#sensorSelect").node().value;
            if (selectedTag == "All")
            {
                d3.select("#geoPoints").selectAll("path").attr("fill-opacity", 1);
            }
            else
            {
                d3.select("#geoPoints").selectAll("path").attr("fill-opacity", 0);
                d3.selectAll("." + selectedTag.replaceAll(":", "\\:")).attr("fill-opacity", 1);
            }
        }

        async function main()
        {
            // load CSVs
            // static_locs = await loadCSV("MC2/data/StaticSensorLocations.csv",
            //     (d) => { return {
            //         id: parseInt(d["Sensor-id"]),
            //         lat: parseFloat(d.Lat),
            //         long: parseFloat(d.Long),
            //     }; }
            // );
            // static_data = await loadCSV("MC2/data/StaticSensorReadings.csv",
            //     (d) => { return {
            //         time: new Date(d.Timestamp),
            //         id: parseInt(d["Sensor-id"]),
            //         val: parseFloat(d.Value),
            //         lat: static_locs.find(loc => loc.id == parseInt(d["Sensor-id"])).lat,
            //         long: static_locs.find(loc => loc.id == parseInt(d["Sensor-id"])).long,
            //     }; }
            // );
            // mobile_data = await loadCSV("MC2/data/MobileSensorReadings.csv",
            //     (d) => { return {
            //         time: new Date(d.Timestamp),
            //         id: parseInt(d["Sensor-id"]),
            //         user: d[" User-id"].trim(),
            //         lat: parseFloat(d.Lat),
            //         long: parseFloat(d.Long),
            //         val: parseFloat(d.Value),
            //     }; }
            // );
            data = await loadData();
            updateSensorSelect(data["val_data"]);
            d3.select("body").append("div").append(() => geographicalPlot(data["agg_data"]));
            d3.select("body").append("div").append(() => sensorHistogram(data["val_data"]));
        }

        main();
    </script>
    <select id="sensorSelect" oninput="onSensorSelect()"></select>
</body>
</html>
